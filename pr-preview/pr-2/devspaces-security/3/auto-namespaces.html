<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Prevent Namespace Auto Creation :: Securing Access to Red Hat OpenShift DevSpaces</title>
    <link rel="prev" href="index.html">
    <link rel="next" href="auth.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../..">Securing Access to Red Hat OpenShift DevSpaces</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/devspaces-security/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="devspaces-security" data-version="3">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Securing Access to Red Hat OpenShift DevSpaces</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Home</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="auto-namespaces.html">Namespace Control</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="auth.html">Authentication</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="rbac.html">Access Control</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="resources.html">Resources</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Securing Access to Red Hat OpenShift DevSpaces</span>
    <span class="version">3</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">Securing Access to Red Hat OpenShift DevSpaces</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">3</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Securing Access to Red Hat OpenShift DevSpaces</a></li>
    <li><a href="auto-namespaces.html">Namespace Control</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Prevent Namespace Auto Creation</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>When you log in as a Dev Spaces user and launch the dashboard, a dedicated namespace (OpenShift project) is <em>automatically</em> created for the user. When this user launches a workspace, the resources used by this workspace are all created in this dedicated namespace. Other Dev Spaces users cannot access this namespace.</p>
</div>
<div class="paragraph">
<p>In some OpenShift installations, there is strict control over who is allowed to create namespaces for security and resource control reasons. Regular users are not allowed to create namespaces. In such scenarios, when users log in, they will not be allowed to access the dashboard since namespace auto-creation has been blocked.</p>
</div>
<div class="paragraph">
<p>You can turn off automatic namespace creation at the CheCluster CR level and then manually create the namespace using the process approved for your setup (GitOps, manually by a platform administrator etc).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ns-mgmt.svg" alt="ns mgmt">
</div>
<div class="title">Figure 1. Namespace Management in Dev Spaces</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lab_disable_dev_spaces_namespace_auto_creation"><a class="anchor" href="#_lab_disable_dev_spaces_namespace_auto_creation"></a>Lab: Disable Dev Spaces Namespace Auto Creation</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in as the <code>admin</code> user using the <code>oc</code> CLI</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc login -u admin <em>&lt;OpenShift API URL&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>By default, namespace auto creation is <strong>enabled</strong> by default</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get checluster/devspaces \
  -n openshift-devspaces \
  -o jsonpath='{.spec.devEnvironments.defaultNamespace.autoProvision}'
<em>true</em></code></pre>
</div>
</div>
</li>
<li>
<p>Inspect and delete any existing user workspaces. Note that as per the default CheCluster CR, the namespaces are in a specific format (<em>&lt;user&gt;</em>-devspaces), where <em>user</em> is the username.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc get projects | grep "user..devspaces"
<em>user1-devspaces   Active
user2-devspaces   Active
user5-devspaces   Active</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc delete namespace user1-devspaces user2-devspaces user5-devspaces
<em>namespace "user1-devspaces" deleted
namespace "user2-devspaces" deleted
namespace "user5-devspaces" deleted</em></code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>devspaces</code> CheCluster CR (using <code>oc edit checluster/devspaces -n openshift-devspaces</code> command), and disable automatic namespace creation by the Dev Spaces operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  components:
    cheServer:
      debug: false
      logLevel: INFO
    dashboard:
...
  devEnvironments:
    containerBuildConfiguration:
      openShiftSecurityContextConstraint: container-build
    <strong>defaultNamespace:
      autoProvision: false</strong>
      template: &lt;username&gt;-devspaces</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the <code>oc patch</code> command as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc patch checluster/devspaces \
  -n openshift-devspaces \
  --type='merge' -p  \
  '{"spec":{"devEnvironments":{"defaultNamespace": {"autoProvision": false}}}}'
<em>checluster.org.eclipse.che/devspaces patched</em></code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the Dev Spaces pods to be restarted with the changes. Log out of all active Dev Spaces sessions.</p>
</li>
<li>
<p>Log in as the <code>user5</code> user and try accessing the Dev Spaces dashboard. You will be denied access, and you will see the following error:</p>
<div class="imageblock">
<div class="content">
<img src="_images/ns-auto-disabled.png" alt="ns auto disabled">
</div>
<div class="title">Figure 2. Automatic Namespace provisioning disabled</div>
</div>
</li>
<li>
<p>To fix this error you need to create the namespace for each of the users you want to provide access. The namespace has to be in the format <code><em>username</em>-devspaces</code> as defined in the CheCluster CR. You also need to add some extra labels and annotations that are expected by Dev Spaces for proper functioning.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc create namespace user5-devspaces
<em>namespace/user5-devspaces created</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ oc label namespace user5-devspaces \
  app.kubernetes.io/part-of=che.eclipse.org \
  app.kubernetes.io/component=workspaces-namespace
<em>namespace/user5-devspaces labeled</em>

$ oc annotate namespace \
  user5-devspaces \
  che.eclipse.org/username=user5
<em>namespace/user5-devspaces annotated</em></code></pre>
</div>
</div>
</li>
<li>
<p>Log out and try logging in again as <code>user5</code>. You should be able to access the Dev Spaces dashboard and launch workspaces.</p>
</li>
<li>
<p>Try logging in as a different user and verify that access to the Dev Spaces is denied unless the namespace with labels and annotations is created separately.</p>
</li>
</ol>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="index.html">Home</a></span>
  <span class="next"><a href="auth.html">Authentication</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
